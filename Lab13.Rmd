---
title: "Lab 13 AD"
output: html_notebook
---


Cargamos los datos:

```{r}
atur <- read.table("./Atur.dat")
atur <- ts(atur, frequency=12, start=1996)

atur_log <- log(atur)
```

# 1 Ajustar modelo ARIMA

```{r}
mod <- arima(atur_log, order=c(0,2,1), seasonal=list(order=c(0,1,1), period=12))
```

#2 Validación del modelo

```{r}
res <- resid(mod)
```

```{r}
library("lmtest")

#################Validation#################################
validation=function(model,dades){
  s=frequency(get(model$series))
  resid=model$residuals
  par(mfrow=c(2,2),mar=c(3,3,3,3))
  #Residuals plot
  plot(resid,main="Residuals")
  abline(h=0)
  abline(h=c(-3*sd(resid),3*sd(resid)),lty=3,col=4)
  #Square Root of absolute values of residuals (Homocedasticity)
  scatter.smooth(sqrt(abs(resid)),main="Square Root of Absolute residuals",
                 lpars=list(col=2))
  
  #Normal plot of residuals
  qqnorm(resid)
  qqline(resid,col=2,lwd=2)
  
  ##Histogram of residuals with normal curve
  hist(resid,breaks=20,freq=FALSE)
  curve(dnorm(x,mean=mean(resid),sd=sd(resid)),col=2,add=T)
  
  
  #ACF & PACF of residuals
  par(mfrow=c(1,2))
  acf(resid,ylim=c(-1,1),lag.max=60,col=c(2,rep(1,s-1)),lwd=1)
  pacf(resid,ylim=c(-1,1),lag.max=60,col=c(rep(1,s-1),2),lwd=1)
  par(mfrow=c(1,1))
  
  #ACF & PACF of square residuals 
  par(mfrow=c(1,2))
  acf(resid^2,ylim=c(-1,1),lag.max=60,col=c(2,rep(1,s-1)),lwd=1)
  pacf(resid^2,ylim=c(-1,1),lag.max=60,col=c(rep(1,s-1),2),lwd=1)
  par(mfrow=c(1,1))
  
  #Ljung-Box p-values
  par(mar=c(2,2,1,1))
  tsdiag(model,gof.lag=7*s)
  cat("\n--------------------------------------------------------------------\n")
  print(model)
  
  #Stationary and Invertible
  cat("\nModul of AR Characteristic polynomial Roots: ", 
      Mod(polyroot(c(1,-model$model$phi))),"\n")
  cat("\nModul of MA Characteristic polynomial Roots: ",
      Mod(polyroot(c(1,model$model$theta))),"\n")
  
  #Model expressed as an MA infinity (psi-weights)
  psis=ARMAtoMA(ar=model$model$phi,ma=model$model$theta,lag.max=36)
  names(psis)=paste("psi",1:36)
  cat("\nPsi-weights (MA(inf))\n")
  cat("\n--------------------\n")
  print(psis[1:20])
  
  #Model expressed as an AR infinity (pi-weights)
  pis=-ARMAtoMA(ar=-model$model$theta,ma=-model$model$phi,lag.max=36)
  names(pis)=paste("pi",1:36)
  cat("\nPi-weights (AR(inf))\n")
  cat("\n--------------------\n")
  print(pis[1:20])
 
  cat("\nNormality Tests\n")
  cat("\n--------------------\n")
 
  ##Shapiro-Wilks Normality test
  print(shapiro.test(resid(model)))

  suppressMessages(require(nortest,quietly=TRUE,warn.conflicts=FALSE))
  ##Anderson-Darling test
  print(ad.test(resid(model)))
  
  suppressMessages(require(tseries,quietly=TRUE,warn.conflicts=FALSE))
  ##Jarque-Bera test
  print(jarque.bera.test(resid(model)))
  
  cat("\nHomoscedasticity Test\n")
  cat("\n--------------------\n")
  suppressMessages(require(lmtest,quietly=TRUE,warn.conflicts=FALSE))
  ##Breusch-Pagan test
  obs=get(model$series)
  print(bptest(resid(model)~I(obs-resid(model))))
  
  cat("\nIndependence Tests\n")
  cat("\n--------------------\n")
  
  ##Durbin-Watson test
  print(dwtest(resid(model)~I(1:length(resid(model)))))
  
  ##Ljung-Box test
  cat("\nLjung-Box test\n")
  print(t(apply(matrix(c(1:4,(1:4)*s)),1,function(el) {
    te=Box.test(resid(model),type="Ljung-Box",lag=el)
    c(lag=(te$parameter),statistic=te$statistic[[1]],p.value=te$p.value)})))
  
  
  #Sample ACF vs. Teoric ACF
  par(mfrow=c(2,2),mar=c(3,3,3,3))
  acf(dades, ylim=c(-1,1) ,lag.max=36,main="Sample ACF")
  
  plot(ARMAacf(model$model$phi,model$model$theta,lag.max=36),ylim=c(-1,1), 
       type="h",xlab="Lag",  ylab="", main="ACF Teoric")
  abline(h=0)
  
  #Sample PACF vs. Teoric PACF
  pacf(dades, ylim=c(-1,1) ,lag.max=36,main="Sample PACF")
  
  plot(ARMAacf(model$model$phi,model$model$theta,lag.max=36, pacf=T),ylim=c(-1,1),
       type="h", xlab="Lag", ylab="", main="PACF Teoric")
  abline(h=0)
  par(mfrow=c(1,1))
}
################# Fi Validaci? #################################
```

```{r}
validation(mod, atur_log)
```

Observamos que en el plot de los residuos se ven unos pocos ouliers pero en general observamos que tiene media nula y cae casi todo dentro de las bandas de confianza. Además, en el plot de la raíz cuadrada del valor absoluto de los residuos podemos observar como la varianza es constante.

Por otra parte, mirando el Q-Q Plot y el histograma de los resiudo observamos que en general siguen una distribución normal, a excepción de algunos outliers que caen fuera de lo esperado. Debido a esto, los tests de normalidad rechazan la hipótesis nula, es decir, rechazan que los residuos sigan una distribución normal. También podemos observar en el ACF del cuadrado de los residuos que hay una correlación significativa en el retardo 1.

Ovservamos ahora si hay inependencia entre los residuos: Mirando tanto el ACF como el PACF notamos que hay algún retaro que sale fuera del intervalo de confianza centrado en cero, pero como es alejado lo podemos ignorar. Además, mirando el plot de Ljung-Box podemos deducir que todos los retardos son independientes. Esto última también lo podemos corroborar con el estadístico de Durbin-Watson.

```{r}
AIC(mod)
BIC(mod)
```

Finalmente, observamos que el AIC es -1638.508 y el BIC -1627.803

# 3

```{r}
prevision <- function(model, data) {
  ultim <- c(2017,12)
  data_2 <-window(data, end=ultim)
  
  mod2 <- update(model, x = data_2)
  
  #prediction 12 next observations
  pred <- predict(mod2, n.ahead=12)
  point <- exp(pred$pred)
  
  up <- point*exp(pred$se * 1.96)
  lo <- point/exp(pred$se * 1.96)
  
  ts.plot(data,lo,up,point,lty=c(1,2,2,1),col=c(1,4,4,2),xlim=c(2013,2019), type="o",
        main="Predicciones de 2018 según el modelo 1") 
  abline(v=2013:2019,lty=3,col=4)
  
  #RMSPE and MAPE
  obs <- window(data, start=c(2018, 1), end=c(2018, 12))

  print(paste0("RMSPE: ", RMSPE<-sqrt(mean(((obs-point)/obs)^2))))
  print(paste0("MAPE: ", MAPE<-mean(abs(obs-point)/obs)))

  print(paste0("Mean conf. interval length: ", mean(up-lo)))
}
```


```{r}
prevision(mod, atur_log)
```





